import{r as w}from"./vendor-D4K9R2Ee.js";import{v as o}from"./index-BhdO03n1.js";const f=new Map,y=5*60*1e3;function m(l){const e=f.get(l);return e&&Date.now()-e.timestamp<e.ttl?e.data:(f.delete(l),null)}function g(l,e,r=y){f.set(l,{data:e,timestamp:Date.now(),ttl:r})}class h{static async getCars(e){const r=`cars:${JSON.stringify(e)}`,t=m(r);if(t)return t;let a=o.from("cars").select("*").eq("is_sold",!1).order("created_at",{ascending:!1});e&&(e.brand&&(a=a.eq("brand",e.brand)),e.minPrice!==void 0&&(a=a.gte("price",e.minPrice)),e.maxPrice!==void 0&&(a=a.lte("price",e.maxPrice)),e.fuelType&&(a=a.eq("fuel_type",e.fuelType)),e.transmission&&(a=a.eq("transmission",e.transmission)),e.minYear!==void 0&&(a=a.gte("year",e.minYear)),e.maxYear!==void 0&&(a=a.lte("year",e.maxYear)),e.isFeatured!==void 0&&(a=a.eq("is_featured",e.isFeatured)),e.isSold!==void 0&&(a=a.eq("is_sold",e.isSold)),e.search&&(a=a.or(`brand.ilike.%${e.search}%,model.ilike.%${e.search}%,description.ilike.%${e.search}%`)),e.limit&&(a=a.limit(e.limit)),e.offset&&(a=a.range(e.offset,e.offset+(e.limit||20)-1)));const{data:s,error:i}=await a;if(i)throw new Error(`Failed to fetch cars: ${i.message}`);const n=s||[];return g(r,n),n}static async getCarById(e){const r=`car:${e}`,t=m(r);if(t)return t;const{data:a,error:s}=await o.from("cars").select("*").eq("id",e).single();if(s){if(s.code==="PGRST116")return null;throw new Error(`Failed to fetch car: ${s.message}`)}return g(r,a,10*60*1e3),a}static async getFeaturedCars(e=6){const r=`featured-cars:${e}`,t=m(r);if(t)return t;const{data:a,error:s}=await o.from("cars").select("*").eq("is_featured",!0).eq("is_sold",!1).order("created_at",{ascending:!1}).limit(e);if(s)throw new Error(`Failed to fetch featured cars: ${s.message}`);const i=a||[];return g(r,i,15*60*1e3),i}static async getCarsByBrand(e,r=20){const t=`cars-brand:${e}:${r}`,a=m(t);if(a)return a;const{data:s,error:i}=await o.from("cars").select("*").eq("brand",e).eq("is_sold",!1).order("created_at",{ascending:!1}).limit(r);if(i)throw new Error(`Failed to fetch cars by brand: ${i.message}`);const n=s||[];return g(t,n),n}static async searchCars(e,r){const t=`search:${e}:${JSON.stringify(r)}`,a=m(t);if(a)return a;let s=o.from("cars").select("*").eq("is_sold",!1).or(`brand.ilike.%${e}%,model.ilike.%${e}%,description.ilike.%${e}%`).order("created_at",{ascending:!1});r&&(r.brand&&(s=s.eq("brand",r.brand)),r.minPrice!==void 0&&(s=s.gte("price",r.minPrice)),r.maxPrice!==void 0&&(s=s.lte("price",r.maxPrice)),r.fuelType&&(s=s.eq("fuel_type",r.fuelType)),r.transmission&&(s=s.eq("transmission",r.transmission)),r.minYear!==void 0&&(s=s.gte("year",r.minYear)),r.maxYear!==void 0&&(s=s.lte("year",r.maxYear)),r.isFeatured!==void 0&&(s=s.eq("is_featured",r.isFeatured)));const{data:i,error:n}=await s;if(n)throw new Error(`Failed to search cars: ${n.message}`);const c=i||[];return g(t,c,2*60*1e3),c}static async createCar(e){const{data:r,error:t}=await o.from("cars").insert(e).select().single();if(t)throw new Error(`Failed to create car: ${t.message}`);return this.invalidateCarCaches(),r}static async updateCar(e,r){const{data:t,error:a}=await o.from("cars").update({...r,updated_at:new Date().toISOString()}).eq("id",e).select().single();if(a)throw new Error(`Failed to update car: ${a.message}`);return this.invalidateCarCaches(),f.delete(`car:${e}`),t}static async deleteCar(e){const{error:r}=await o.from("cars").delete().eq("id",e);if(r)throw new Error(`Failed to delete car: ${r.message}`);this.invalidateCarCaches(),f.delete(`car:${e}`)}static invalidateCarCaches(){Array.from(f.keys()).filter(r=>r.startsWith("cars:")||r.startsWith("featured-cars:")||r.startsWith("cars-brand:")||r.startsWith("search:")).forEach(r=>f.delete(r))}static async getFavorites(e){const r=`favorites:${e}`,t=m(r);if(t)return t;const{data:a,error:s}=await o.from("favorites").select(`
        *,
        cars (*)
      `).eq("user_id",e).order("created_at",{ascending:!1});if(s)throw new Error(`Failed to fetch favorites: ${s.message}`);const i=a||[];return g(r,i,3*60*1e3),i}static async addToFavorites(e,r){const{data:t,error:a}=await o.from("favorites").insert({user_id:e,car_id:r}).select().single();if(a)throw new Error(`Failed to add to favorites: ${a.message}`);return f.delete(`favorites:${e}`),t}static async removeFromFavorites(e,r){const{error:t}=await o.from("favorites").delete().eq("user_id",e).eq("car_id",r);if(t)throw new Error(`Failed to remove from favorites: ${t.message}`);f.delete(`favorites:${e}`)}static async isFavorite(e,r){const t=`favorite-check:${e}:${r}`,a=m(t);if(a!==null)return a;const{data:s,error:i}=await o.from("favorites").select("id").eq("user_id",e).eq("car_id",r).single();if(i){if(i.code==="PGRST116")return g(t,!1,1*60*1e3),!1;throw new Error(`Failed to check favorite status: ${i.message}`)}const n=!!s;return g(t,n,1*60*1e3),n}static async getUser(e){const{data:r,error:t}=await o.from("users").select("*").eq("id",e).single();if(t)throw new Error(`Failed to fetch user: ${t.message}`);return r}static async updateUser(e,r){const{data:t,error:a}=await o.from("users").update({...r,updated_at:new Date().toISOString()}).eq("id",e).select().single();if(a)throw new Error(`Failed to update user: ${a.message}`);return t}static async updateUserProfile(e,r){try{const{data:t,error:a}=await o.from("users").update({...r,updated_at:new Date().toISOString()}).eq("id",e).select().single();if(a){const{data:s,error:i}=await o.from("users").insert({id:e,...r,created_at:new Date().toISOString(),updated_at:new Date().toISOString()}).select().single();if(i)throw new Error(`Failed to create user profile: ${i.message}`);return s}return t}catch{const{data:{user:a},error:s}=await o.auth.updateUser({data:r});if(s)throw new Error(`Failed to update user profile: ${s.message}`);return{id:a?.id,email:a?.email,...r,created_at:a?.created_at,updated_at:new Date().toISOString()}}}static async signUp(e,r,t){const{data:a,error:s}=await o.auth.signUp({email:e,password:r,options:{data:t}});if(s)throw new Error(`Failed to sign up: ${s.message}`);return a}static async signIn(e,r){const{data:t,error:a}=await o.auth.signInWithPassword({email:e,password:r});if(a)throw new Error(`Failed to sign in: ${a.message}`);return t}static async signOut(){const{error:e}=await o.auth.signOut();if(e)throw new Error(`Failed to sign out: ${e.message}`)}static async getCurrentUser(){const{data:{user:e},error:r}=await o.auth.getUser();if(r)throw new Error(`Failed to get current user: ${r.message}`);return e}static async getCurrentUserProfile(){const{data:{user:e},error:r}=await o.auth.getUser();if(r)throw new Error(`Failed to get current user: ${r.message}`);if(!e)return null;try{const{data:t,error:a}=await o.from("users").select("*").eq("id",e.id).single();return a?{id:e.id,email:e.email,full_name:e.user_metadata?.full_name||"",phone:e.user_metadata?.phone||"",avatar_url:e.user_metadata?.avatar_url||null,is_admin:e.user_metadata?.is_admin||!1,created_at:e.created_at,updated_at:e.updated_at}:t}catch{return{id:e.id,email:e.email,full_name:e.user_metadata?.full_name||"",phone:e.user_metadata?.phone||"",avatar_url:e.user_metadata?.avatar_url||null,is_admin:e.user_metadata?.is_admin||!1,created_at:e.created_at,updated_at:e.updated_at}}}static async resetPassword(e){const{error:r}=await o.auth.resetPasswordForEmail(e,{redirectTo:`${window.location.origin}/reset-password`});if(r)throw new Error(`Failed to reset password: ${r.message}`)}}const v=()=>{const[l,e]=w.useState({user:null,session:null,loading:!0,userProfile:null});return w.useEffect(()=>{(async()=>{const{data:{session:c},error:d}=await o.auth.getSession();if(d){console.error("Error getting session:",d),e(u=>({...u,loading:!1}));return}if(c?.user)try{const u=await h.getCurrentUserProfile();e({user:c.user,session:c,loading:!1,userProfile:u})}catch(u){console.error("Error getting user profile:",u),e({user:c.user,session:c,loading:!1,userProfile:null})}else e({user:null,session:null,loading:!1,userProfile:null})})();const{data:{subscription:n}}=o.auth.onAuthStateChange(async(c,d)=>{if(!l.loading)if(d?.user)try{e(p=>({...p,loading:!0}));const u=await h.getCurrentUserProfile();e({user:d.user,session:d,loading:!1,userProfile:u})}catch(u){console.error("Error getting user profile:",u),e({user:d.user,session:d,loading:!1,userProfile:null})}else e({user:null,session:null,loading:!1,userProfile:null})});return()=>n.unsubscribe()},[]),{...l,signUp:async(i,n,c)=>{try{return e(u=>({...u,loading:!0})),await h.signUp(i,n,c)}catch(d){throw d}finally{e(d=>({...d,loading:!1}))}},signIn:async(i,n)=>{try{return e(d=>({...d,loading:!0})),await h.signIn(i,n)}catch(c){throw c}finally{e(c=>({...c,loading:!1}))}},signOut:async()=>{try{e(i=>({...i,loading:!0})),await h.signOut()}catch(i){throw i}finally{e(i=>({...i,loading:!1}))}},updateProfile:async i=>{if(!l.user)throw new Error("No user logged in");try{const n=await h.updateUserProfile(l.user.id,i);return e(c=>({...c,userProfile:n})),n}catch(n){throw n}}}};export{v as u};
